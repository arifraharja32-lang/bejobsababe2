<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BaBe Aja - Jual Beli Barang Bekas Terdekat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; }
        .hidden-input { display: none; }
        .card-shadow { box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .bg-bukalapak { background-color: #E31E52; }
        .text-bukalapak { color: #E31E52; }
        .btn-primary { background-color: #E31E52; color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; width: 100%; display: block; transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
        
        .bottom-nav-item { color: #666; font-weight: 500; transition: all 0.2s; }
        .active-nav { color: #E31E52 !important; }
        .nav-icon-container { padding: 4px; border-radius: 50%; }
        .active-nav .nav-icon-container { background-color: #fff1f4; }
        
        .image-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .image-slider::-webkit-scrollbar { display: none; }
        .image-slider .slide-item {
            flex: 0 0 100%;
            scroll-snap-align: start;
            height: 100%;
            position: relative;
        }
        .image-slider img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        html, body { overscroll-behavior-y: contain; touch-action: pan-y; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen pb-24 shadow-xl">

    <!-- Header -->
    <header class="bg-bukalapak text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <div class="flex items-center space-x-2">
            <span class="text-2xl">üì¶</span>
            <h1 class="text-xl font-black tracking-tight">BaBe Aja</h1>
        </div>
        <button onclick="showPage('upload')" class="bg-white text-bukalapak px-4 py-1.5 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition-transform">
            + Jual
        </button>
    </header>

    <!-- Location Status Banner -->
    <div id="location-status" class="bg-yellow-100 text-[10px] text-yellow-800 px-4 py-2 text-center font-bold border-b border-yellow-200">
        Sedang mendeteksi lokasi...
    </div>

    <!-- Main Content: Home Page -->
    <main id="page-home" class="p-4">
        <div class="mb-5 space-y-3">
            <div class="relative">
                <span class="absolute left-3 top-3 text-gray-400">üîç</span>
                <input type="text" id="search-input" oninput="filterProducts()" placeholder="Cari barang bekas..." class="w-full pl-10 pr-4 py-3 border rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-red-500 transition-all text-sm">
            </div>
            
            <div id="product-list" class="grid grid-cols-2 gap-3">
                <!-- Produk dinamis -->
            </div>
        </div>
    </main>

    <!-- Page: Account -->
    <section id="page-account" class="hidden p-4 text-center">
        <div class="flex items-center mb-6">
            <button onclick="showPage('home')" class="mr-4 text-bukalapak p-2 bg-red-50 rounded-full">‚Üê</button>
            <h2 class="text-xl font-bold text-gray-800">Akun Saya</h2>
        </div>
        <div class="py-10">
            <div class="w-20 h-20 bg-gray-200 rounded-full mx-auto mb-4 flex items-center justify-center text-gray-400 text-3xl">üë§</div>
            <p class="font-bold text-gray-700">Pengguna BaBe</p>
            
            <div class="mt-8 border-t pt-4 text-left px-4">
                <h3 class="font-bold text-sm mb-3 text-bukalapak uppercase tracking-wider">Iklan Saya</h3>
                <div id="my-products-list" class="space-y-3"></div>
            </div>
        </div>
    </section>

    <!-- Page: Upload -->
    <section id="page-upload" class="hidden p-4">
        <div class="flex items-center mb-6">
            <button onclick="showPage('home')" class="mr-4 text-bukalapak p-2 bg-red-50 rounded-full">‚Üê</button>
            <h2 class="text-xl font-bold text-gray-800">Buat Iklan</h2>
        </div>

        <div class="space-y-4 pb-10">
            <div class="bg-gray-50 border-2 border-dashed border-red-200 rounded-2xl p-4 text-center">
                <p class="text-[10px] font-bold text-red-800 mb-2 uppercase tracking-widest">üì∏ Foto Barang (Wajib 5)</p>
                <div id="upload-preview-container" class="grid grid-cols-3 gap-2 mb-3"></div>
                <button onclick="document.getElementById('input-foto-multiple').click()" class="w-full bg-white border border-red-200 py-3 rounded-xl font-bold text-bukalapak text-[10px] shadow-sm uppercase">
                    + Tambah Foto
                </button>
                <input type="file" accept="image/*" id="input-foto-multiple" multiple class="hidden-input" onchange="handleFiles(this)">
            </div>

            <div class="bg-white border-b border-gray-100 p-2">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Nama Barang & Harga</label>
                <input type="text" id="title" placeholder="Supra X 125 - 6jt" class="w-full p-2 outline-none text-sm font-semibold">
            </div>

            <div class="bg-white border-b border-gray-100 p-2">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">WhatsApp</label>
                <input type="number" id="wa-number" placeholder="628xxx" class="w-full p-2 outline-none text-sm font-semibold">
            </div>

            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                <p id="upload-location-text" class="text-[10px] text-blue-700 font-bold">üìç Mendeteksi lokasi...</p>
            </div>

            <button onclick="submitProduct()" id="btn-submit" class="btn-primary uppercase tracking-widest text-sm opacity-50 cursor-not-allowed" disabled>
                Tayangkan Iklan
            </button>
        </div>
    </section>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center h-16 max-w-md mx-auto shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-40">
        <button onclick="showPage('home')" id="nav-home" class="bottom-nav-item flex flex-col items-center flex-1 py-2 active-nav">
            <div class="nav-icon-container mb-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            </div>
            <span class="text-[10px] uppercase font-bold tracking-tight">Home</span>
        </button>
        <button onclick="showPage('account')" id="nav-account" class="bottom-nav-item flex flex-col items-center flex-1 py-2">
            <div class="nav-icon-container mb-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
            <span class="text-[10px] uppercase font-bold tracking-tight">Akun</span>
        </button>
    </nav>

    <script>
        // 12 Dummy Data yang Bervariasi
        const defaultProducts = [
            { id: 1, title: "Honda Vario 150 - 14jt", wa: "62812345678", images: ["https://images.unsplash.com/photo-1558981806-ec527fa84c39?w=500", "https://images.unsplash.com/photo-1568772585407-9361f9bf3a87?w=500", "https://images.unsplash.com/photo-1599819811279-d5ad9cccf838?w=500", "https://images.unsplash.com/photo-1444491741275-3747c53c99b4?w=500", "https://images.unsplash.com/photo-1591637333184-19aa84b3e01f?w=500"], location: "Kec. Coblong, Kota Bandung", lat: -6.8850, lon: 107.6135, isMine: false },
            { id: 2, title: "Macbook Air M1 - 9.5jt", wa: "62812345679", images: ["https://images.unsplash.com/photo-1611186871348-b1ce696e52c9?w=500", "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=500", "https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=500", "https://images.unsplash.com/photo-1541807084-5c52b6b3adef?w=500", "https://images.unsplash.com/photo-1588872657578-7efd1f1555ed?w=500"], location: "Kec. Gambir, Jakarta Pusat", lat: -6.1750, lon: 106.8272, isMine: false },
            { id: 3, title: "Sepeda Lipat - 3.2jt", wa: "62812345671", images: ["https://images.unsplash.com/photo-1571068316344-75bc76f77891?w=500", "https://images.unsplash.com/photo-1485965120184-e220f721d03e?w=500", "https://images.unsplash.com/photo-1507035895480-2b3156c31fc8?w=500", "https://images.unsplash.com/photo-1532298229144-0ee0c97d159b?w=500", "https://images.unsplash.com/photo-1576435728678-68d0fbf94e91?w=500"], location: "Kec. Ciputat, Tangerang Selatan", lat: -6.3090, lon: 106.7480, isMine: false },
            { id: 4, title: "iPhone 13 Pro 256GB - 11jt", wa: "62812345672", images: ["https://images.unsplash.com/photo-1632661674596-df8be070a5c5?w=500", "https://images.unsplash.com/photo-1510557880182-3d4d3cba3f95?w=500", "https://images.unsplash.com/photo-1591337676887-a217a6970c8a?w=500", "https://images.unsplash.com/photo-1556656793-062ff9878258?w=500", "https://images.unsplash.com/photo-1537498425277-c283d32ef9db?w=500"], location: "Kec. Tegalsari, Surabaya", lat: -7.2654, lon: 112.7356, isMine: false },
            { id: 5, title: "Kamera Sony A6400 - 10jt", wa: "62812345673", images: ["https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=500", "https://images.unsplash.com/photo-1502920917128-1aa500764cbd?w=500", "https://images.unsplash.com/photo-1520390138845-fd2d229dd553?w=500", "https://images.unsplash.com/photo-1495707902641-75cac588d2e9?w=500", "https://images.unsplash.com/photo-1500643752441-4dc90cda350a?w=500"], location: "Kec. Gajahmungkur, Semarang", lat: -7.0125, lon: 110.4101, isMine: false },
            { id: 6, title: "Meja Kayu Jati - 1.5jt", wa: "62812345674", images: ["https://images.unsplash.com/photo-1533090161767-e6ffed986c88?w=500", "https://images.unsplash.com/photo-1577146333359-3d047771f251?w=500", "https://images.unsplash.com/photo-1592078615290-033ee584e267?w=500", "https://images.unsplash.com/photo-1530018607912-eff2df114f11?w=500", "https://images.unsplash.com/photo-1565791380713-1716b9255055?w=500"], location: "Kec. Depok, Sleman", lat: -7.7713, lon: 110.4078, isMine: false },
            { id: 7, title: "Gitar Yamaha APX - 1.8jt", wa: "62812345675", images: ["https://images.unsplash.com/photo-1550291652-6ea9114a47b1?w=500", "https://images.unsplash.com/photo-1510915361894-db8b60106cb1?w=500", "https://images.unsplash.com/photo-1525201548942-d8b8bb097fb3?w=500", "https://images.unsplash.com/photo-1441113548235-517f95039b06?w=500", "https://images.unsplash.com/photo-1550985543-565650123519?w=500"], location: "Kec. Klojen, Malang", lat: -7.9785, lon: 112.6280, isMine: false },
            { id: 8, title: "Kulkas LG 2 Pintu - 2.5jt", wa: "62812345676", images: ["https://images.unsplash.com/photo-1571175443880-49e1d25b2bc5?w=500", "https://images.unsplash.com/photo-1584622650111-993a426fbf0a?w=500", "https://images.unsplash.com/photo-1536353284924-9220c464e262?w=500", "https://images.unsplash.com/photo-1550989460-0adf9ea622e2?w=500", "https://images.unsplash.com/photo-1494438639946-1ebd1d20bf85?w=500"], location: "Kec. Medan Baru, Medan", lat: 3.5852, lon: 98.6585, isMine: false },
            { id: 9, title: "PS5 Disc Edition - 7jt", wa: "62812345677", images: ["https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?w=500", "https://images.unsplash.com/photo-1607853202273-797f1c22a38e?w=500", "https://images.unsplash.com/photo-1622239483510-5c3937199c8d?w=500", "https://images.unsplash.com/photo-1605898960764-7bc67eba005a?w=500", "https://images.unsplash.com/photo-1593305841991-05c297ba4575?w=500"], location: "Kec. Mariso, Makassar", lat: -5.1610, lon: 119.4095, isMine: false },
            { id: 10, title: "Jam Tangan Seiko - 2.2jt", wa: "62812345680", images: ["https://images.unsplash.com/photo-1524592091214-b4469ded5ce3?w=500", "https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?w=500", "https://images.unsplash.com/photo-1539533397308-a61e4e7c00d8?w=500", "https://images.unsplash.com/photo-1542496658-e33a6d0d50f6?w=500", "https://images.unsplash.com/photo-1508057198894-247b23fe5ade?w=500"], location: "Kec. Denpasar Timur, Bali", lat: -8.6585, lon: 115.2439, isMine: false },
            { id: 11, title: "Drone DJI Mini 2 - 5.5jt", wa: "62812345681", images: ["https://images.unsplash.com/photo-1507582020474-9a35b7d455d9?w=500", "https://images.unsplash.com/photo-1473968512647-3e447244af8f?w=500", "https://images.unsplash.com/photo-1527977966376-1c841de9d21a?w=500", "https://images.unsplash.com/photo-1508614589041-895b88991e3e?w=500", "https://images.unsplash.com/photo-1501612780327-45045538702b?w=500"], location: "Kec. Ilir Barat I, Palembang", lat: -2.9814, lon: 104.7291, isMine: false },
            { id: 12, title: "Sepatu Nike Air Jordan - 2.8jt", wa: "62812345682", images: ["https://images.unsplash.com/photo-1584735175315-9d5df23860e6?w=500", "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=500", "https://images.unsplash.com/photo-1549298916-b41d501d3772?w=500", "https://images.unsplash.com/photo-1600185365483-26d7a4cc7519?w=500", "https://images.unsplash.com/photo-1605348532760-6753d2c43329?w=500"], location: "Kec. Banjarmasin Tengah", lat: -3.3166, lon: 114.5901, isMine: false }
        ];

        let products = JSON.parse(localStorage.getItem('babe_products_v4')) || defaultProducts;
        let uploadedImages = [];
        let userPos = null;
        let currentAddress = "Lokasi Tidak Diketahui";

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function getReverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                const addr = data.address;
                const kec = addr.suburb || addr.village || addr.town || "Kec. Tidak Terdeteksi";
                const kab = addr.city || addr.regency || addr.county || "Kab. Tidak Terdeteksi";
                return `Kec. ${kec}, ${kab}`;
            } catch (e) {
                return "Lokasi Terdeteksi";
            }
        }

        function initGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    currentAddress = await getReverseGeocode(userPos.lat, userPos.lon);
                    
                    document.getElementById('location-status').innerHTML = `üìç Aktif: ${currentAddress} (Radius 100km)`;
                    document.getElementById('location-status').className = "bg-green-100 text-[10px] text-green-800 px-4 py-2 text-center font-bold border-b border-green-200";
                    document.getElementById('upload-location-text').innerHTML = `üìç Lokasi Iklan: ${currentAddress}`;
                    document.getElementById('btn-submit').disabled = false;
                    document.getElementById('btn-submit').classList.remove('opacity-50', 'cursor-not-allowed');
                    renderProducts();
                }, (err) => {
                    document.getElementById('location-status').innerHTML = "‚ö†Ô∏è GPS Mati: Menampilkan semua iklan";
                    document.getElementById('location-status').className = "bg-red-100 text-[10px] text-red-800 px-4 py-2 text-center font-bold border-b border-red-200";
                    renderProducts();
                });
            }
        }

        function showPage(page) {
            document.querySelectorAll('main, section').forEach(s => s.classList.add('hidden'));
            document.getElementById('page-' + page).classList.remove('hidden');
            document.getElementById('nav-home').classList.toggle('active-nav', page === 'home');
            document.getElementById('nav-account').classList.toggle('active-nav', page === 'account');
            if (page === 'account') renderMyProducts();
            window.scrollTo(0,0);
        }

        function handleFiles(input) {
            const files = Array.from(input.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if(uploadedImages.length < 5) {
                        uploadedImages.push(e.target.result);
                        renderUploadPreview();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function renderUploadPreview() {
            const container = document.getElementById('upload-preview-container');
            container.innerHTML = uploadedImages.map((src, idx) => `
                <div class="relative h-20 bg-gray-200 rounded-lg overflow-hidden border">
                    <img src="${src}" class="w-full h-full object-cover">
                    <button onclick="removeImage(${idx})" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 text-[10px] rounded-bl-lg">‚úï</button>
                </div>
            `).join('');
        }

        function removeImage(idx) {
            uploadedImages.splice(idx, 1);
            renderUploadPreview();
        }

        function submitProduct() {
            const title = document.getElementById('title').value;
            const wa = document.getElementById('wa-number').value;

            if (uploadedImages.length < 5) { alert("Wajib 5 foto!"); return; }
            if (!title || !wa) { alert("Data belum lengkap!"); return; }

            const newProduct = {
                id: Date.now(),
                title: title,
                wa: wa,
                images: [...uploadedImages],
                lat: userPos.lat,
                lon: userPos.lon,
                location: currentAddress,
                isMine: true
            };

            products.unshift(newProduct);
            localStorage.setItem('babe_products_v4', JSON.stringify(products));
            uploadedImages = [];
            showPage('home');
            renderProducts();
        }

        function renderProducts() {
            const list = document.getElementById('product-list');
            const query = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = products.filter(p => p.title.toLowerCase().includes(query));

            if (userPos) {
                filtered = filtered.filter(p => {
                    if(p.isMine) return true;
                    const dist = getDistance(userPos.lat, userPos.lon, p.lat, p.lon);
                    p.currentDistance = dist.toFixed(1);
                    // Radius ditingkatkan ke 100km untuk demo agar produk terlihat
                    return dist <= 100; 
                });
            }

            list.innerHTML = filtered.map(p => `
                <div class="bg-white rounded-xl overflow-hidden border border-gray-100 card-shadow flex flex-col h-full">
                    <div class="relative h-40">
                        <div class="image-slider w-full h-full">
                            ${p.images.map(img => `<div class="slide-item"><img src="${img}" loading="lazy"></div>`).join('')}
                        </div>
                        ${p.currentDistance ? `<div class="absolute bottom-2 right-2 bg-bukalapak text-white text-[8px] px-1.5 py-0.5 rounded font-bold shadow">${p.currentDistance} km</div>` : ''}
                        <div class="absolute top-2 right-2 bg-black/40 text-white text-[7px] px-1.5 py-0.5 rounded-full font-bold">GESER üëã</div>
                    </div>
                    <div class="p-3 flex-1 flex flex-col justify-between">
                        <div>
                            <h3 class="font-bold text-[11px] text-gray-800 leading-tight mb-1 line-clamp-2 h-8 uppercase tracking-tighter">${p.title}</h3>
                            <div class="inline-block bg-indigo-50 px-2 py-0.5 rounded-md mb-2">
                                <p class="text-[9px] text-indigo-600 font-bold">üìç ${p.location}</p>
                            </div>
                        </div>
                        <a href="https://wa.me/${p.wa}" target="_blank" class="w-full bg-[#25D366] text-white py-2 rounded-lg font-bold text-[10px] text-center uppercase">WhatsApp</a>
                    </div>
                </div>
            `).join('');
        }

        function renderMyProducts() {
            const list = document.getElementById('my-products-list');
            const myItems = products.filter(p => p.isMine);
            list.innerHTML = myItems.map(p => `
                <div class="flex items-center space-x-3 p-3 bg-white border rounded-lg shadow-sm">
                    <img src="${p.images[0]}" class="w-12 h-12 object-cover rounded">
                    <div class="flex-1 text-left"><p class="text-[10px] font-bold truncate">${p.title}</p></div>
                    <button onclick="deleteProduct(${p.id})" class="text-[9px] text-red-500 font-bold uppercase">Hapus</button>
                </div>
            `).join('');
        }

        function deleteProduct(id) {
            if(confirm("Hapus?")) {
                products = products.filter(p => p.id !== id);
                localStorage.setItem('babe_products_v4', JSON.stringify(products));
                renderMyProducts();
                renderProducts();
            }
        }

        function filterProducts() { renderProducts(); }

        window.onload = initGeolocation;
    </script>
</body>
</html>
